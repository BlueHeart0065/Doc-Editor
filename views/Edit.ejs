<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= doc.title %> - Doc Editor</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles/Edit.css">
    <link rel="stylesheet" href="/styles/templates/topbar.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>">
</head>
<body>
    <div class="topbar">
        <a class="logo" href="/docs">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
            </div>
            <div class="brand">Doc Editor</div>
        </a>
        
        <div class="document-info">
            <div class="document-status">
                <span id="save-indicator" class="save-indicator">Saved</span>
                <span class="last-modified">Last modified: <%= new Date(doc.updatedAt).toLocaleString() %></span>
            </div>
        </div>
        
        <div class="options">
            <a href="/docs" class="nav-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9,22 9,12 15,12 15,22"></polyline>
                </svg>
                Dashboard
            </a>
            <button id="share-btn" class="share-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
                Share
            </button>
            <button id="export-btn" class="export-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7,10 12,15 17,10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export
            </button>
        </div>

        <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
            <svg id="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
        
        <div class="profile">
            <img src="/images/sahil.png" alt="Profile" class="profile-pic">
            <div class="profile-info">
                <div class="name">Sahil Batgeri</div>
                <div class="role">Editor</div>
            </div>
        </div>
    </div>
    
    <!-- Collaboration Status -->
    <div class="collaboration-bar">
        <div class="active-users" id="active-users">
            <span class="users-label">Active editors:</span>
            <div class="user-avatars" id="user-avatars">
                <div class="user-avatar current-user" title="You">
                    <img src="/images/sahil.png" alt="You">
                </div>
            </div>
        </div>
        <div class="document-actions">
            <button id="word-count-btn" class="action-btn" title="Document statistics">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="9" x2="15" y2="9"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
            </button>
            <button id="fullscreen-btn" class="action-btn" title="Toggle fullscreen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                </svg>
            </button>
            <button id="focus-mode-btn" class="action-btn" title="Focus mode">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Hidden elements for data -->
    <span id="id" style="display: none;"><%= id %></span>
    
    <!-- Document Title -->
    <div class="title-container">
        <input type="text" name="title" id="title" value="<%= doc.title %>" placeholder="Untitled Document">
    </div>
    
    <!-- Editor Container -->
    <div class="editor-container">
        <div id="editor" name="editor" contenteditable="true">
            <%- doc.content %>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <button id="fab-main" class="fab" title="Quick actions">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="2"></circle>
                <circle cx="19" cy="12" r="2"></circle>
                <circle cx="5" cy="12" r="2"></circle>
            </svg>
        </button>
        <div class="fab-options" id="fab-options">
            <button class="fab-option" id="back-to-docs" title="Back to Documents">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                </svg>
            </button>
            <button class="fab-option" id="print-doc" title="Print">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 6,2 18,2 18,9"></polyline>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
            </button>
            <button class="fab-option" id="download-doc" title="Download">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7,10 12,15 17,10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </button>
        </div>
    </div>

    <!-- Word Count Modal -->
    <div id="word-count-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Document Statistics</h3>
                <button class="close-btn" id="close-word-count">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Words:</span>
                    <span class="stat-value" id="word-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Characters:</span>
                    <span class="stat-value" id="char-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Characters (no spaces):</span>
                    <span class="stat-value" id="char-count-no-spaces">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Paragraphs:</span>
                    <span class="stat-value" id="paragraph-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Reading time:</span>
                    <span class="stat-value" id="reading-time">0 min</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last saved:</span>
                    <span class="stat-value" id="last-saved">Now</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share Document</h3>
                <button class="close-btn" id="close-share">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="share-options">
                <div class="share-option">
                    <label>Document Link:</label>
                    <div class="link-container">
                        <input type="text" id="document-link" readonly>
                        <button id="copy-link" class="copy-btn">Copy</button>
                    </div>
                </div>
                <div class="share-option">
                    <label>Share via:</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <button class="share-platform-btn" data-platform="email">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                            Email
                        </button>
                        <button class="share-platform-btn" data-platform="twitter">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
                            </svg>
                            Twitter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/scripts/theme.js"></script>
    <script src="/scripts/quill.js"></script>
    <script src="/scripts/autosave.js"></script>
    <script src="/scripts/collaboration.js"></script>
    <script>
        // Initialize Socket.IO connection
        const socket = io();
        const documentId = '<%= id %>';

        // Join the document-specific room
        socket.emit('join-document', documentId);

        // Handle real-time updates
        socket.on('document-update', (data) => {
            if (data.title !== document.getElementById('title').value) {
                document.getElementById('title').value = data.title;
            }
            // Note: We should be careful about updating content while user is typing
        });

        // Handle user connections
        socket.on('user-connected', (message) => {
            console.log(message);
            addActiveUser();
        });

        socket.on('user-disconnected', (message) => {
            console.log(message);
            removeActiveUser();
        });

        function addActiveUser() {
            const userAvatars = document.getElementById('user-avatars');
            const newUser = document.createElement('div');
            newUser.className = 'user-avatar';
            newUser.innerHTML = '<div class="avatar-placeholder">U</div>';
            userAvatars.appendChild(newUser);
        }

        function removeActiveUser() {
            const userAvatars = document.getElementById('user-avatars');
            const users = userAvatars.querySelectorAll('.user-avatar:not(.current-user)');
            if (users.length > 0) {
                users[users.length - 1].remove();
            }
        }

        // Set document link for sharing
        document.getElementById('document-link').value = window.location.href;

        // Focus mode functionality
        document.getElementById('focus-mode-btn').addEventListener('click', function() {
            document.body.classList.toggle('focus-mode');
            const toolbar = document.querySelector('.ql-toolbar');
            const collabBar = document.querySelector('.collaboration-bar');
            
            if (document.body.classList.contains('focus-mode')) {
                toolbar.style.opacity = '0.3';
                collabBar.style.opacity = '0.3';
                this.title = 'Exit focus mode';
            } else {
                toolbar.style.opacity = '1';
                collabBar.style.opacity = '1';
                this.title = 'Focus mode';
            }
        });

        // Enhanced save indicator
        function updateSaveIndicator(status, message = '') {
            const indicator = document.getElementById('save-indicator');
            indicator.className = `save-indicator ${status}`;
            
            switch(status) {
                case 'saving':
                    indicator.textContent = 'Saving...';
                    break;
                case 'saved':
                    indicator.textContent = 'Saved';
                    break;
                case 'error':
                    indicator.textContent = 'Error saving';
                    break;
            }
        }

        // Listen for autosave events
        window.addEventListener('autosave-start', () => updateSaveIndicator('saving'));
        window.addEventListener('autosave-success', () => updateSaveIndicator('saved'));
        window.addEventListener('autosave-error', () => updateSaveIndicator('error'));
    </script>
</body>
</html>